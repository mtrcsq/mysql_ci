<project>
    <shortName>sequoiasql</shortName>
    <fullName>SequoiaSQL MySQL Server</fullName>
    <version>1.0</version>
    <installerFilename>${product_shortname}-mysql-${product_version}-${platform}${edition}-installer.${platform_exec_suffix}</installerFilename>
    <allowLanguageSelection>1</allowLanguageSelection>
    <allowedLanguages>en zh_CN</allowedLanguages>

    <customLanguageFileList>
        <language>
            <code>en</code>
            <encoding>utf-8</encoding>
            <file>${build_project_directory}/sequoiamysql_en.lng</file>
        </language>
        <language>
            <code>zh_CN</code>
            <encoding>utf-8</encoding>
            <file>${build_project_directory}/sequoiamysql_zh.lng</file>
        </language>
    </customLanguageFileList>

    <functionDefinitionList>
        <actionDefinition name="checkUmaskFunction">
            <actionList>
                <setInstallerVariableFromScriptOutput>
                    <name>full_mask</name>
                    <exec>umask</exec>
                </setInstallerVariableFromScriptOutput>
                <setInstallerVariableFromScriptOutput>
                    <name>other_mask</name>
                    <exec>echo</exec>
                    <execArgs>${full_mask} | awk '{print substr($0,length($0)-0,1)}'</execArgs>
                </setInstallerVariableFromScriptOutput>
                <setInstallerVariableFromScriptOutput>
                    <name>group_mask</name>
                    <exec>echo</exec>
                    <execArgs>${full_mask} | awk '{print substr($0,length($0)-1,1)}'</execArgs>
                </setInstallerVariableFromScriptOutput>
                <setInstallerVariableFromScriptOutput>
                    <name>user_mask</name>
                    <exec>echo</exec>
                    <execArgs>${full_mask} | awk '{print substr($0,length($0)-2,1)}'</execArgs>
                </setInstallerVariableFromScriptOutput>
                <showWarning>
                    <text>${msg(install.warnmsg.checkumask)}</text>
                    <ruleEvaluationLogic>or</ruleEvaluationLogic>
                    <ruleList>
                        <compareValues value1="${other_mask}" logic="greater" value2="2"/>
                        <compareValues value1="${group_mask}" logic="greater" value2="2"/>
                        <compareValues value1="${user_mask}"  logic="greater" value2="0"/>
                    </ruleList>
                </showWarning>
            </actionList>
        </actionDefinition>
   
        <actionDefinition name="checkFreeDiskSpaceFunction">
            <actionList>
                <throwError>
                    <text>${msg(install.errmsg.checkdisk)}</text>
                    <ruleList>
                        <checkFreeDiskSpace>
                            <logic>less_or_equal</logic>
                            <path>${installdir}</path>
                            <size>1000000</size>
                        </checkFreeDiskSpace>
                    </ruleList>
                </throwError>
            </actionList>
        </actionDefinition>
   
   </functionDefinitionList>

    <initializationActionList>
        <createTimeStamp>
            <variable>time</variable>
            <format>%Y-%m-%d-%H:%M:%S</format>
        </createTimeStamp>                 
        <setInstallerVariable name="project.rollbackBackupDirectory" value="${installdir}/rollback/BackupDir_${time}"/> 
        <setInstallerVariable name="sys_conf_file" value="/etc/default/sequoiasql-mysql" persist="1"/>
        <setInstallerVariable name="add_user_done"                   value="false"/>
        <setInstallerVariable name="add_group_done"                  value="false"/>
        <setInstallerVariable name="add_sysconf_done"                value="false"/>
        <setInstallerVariable name="exist_installinfo"      value="false"/>
    </initializationActionList>
    
    <preInstallationActionList>

        <!--parameter passed in command line, should not ask again in dialog or gui-->
        <setInstallerVariable name="parameter(installdir).ask" value="0">
            <ruleList>
                <compareText text="${installer_command_line_arguments}" value="--prefix" logic="contains"/>
            </ruleList>
        </setInstallerVariable>
        <setInstallerVariable name="parameter(user_data).parameter(username).ask" value="0">
            <ruleList>
                <compareText text="${installer_command_line_arguments}" value="--user" logic="contains"/>
            </ruleList>
        </setInstallerVariable>
        <setInstallerVariable name="parameter(user_data).parameter(groupname).ask" value="0">
            <ruleList>
                <compareText text="${installer_command_line_arguments}" value="--group" logic="contains"/>
            </ruleList>
        </setInstallerVariable>
        <setInstallerVariable name="parameter(user_data).parameter(userpasswd).ask" value="0">
            <ruleList>
                <compareText text="${installer_command_line_arguments}" value="--passwd" logic="contains"/>
            </ruleList>
        </setInstallerVariable>
        <setInstallerVariable name="parameter(user_data).ask" value="0">
            <ruleEvaluationLogic>and</ruleEvaluationLogic>
            <ruleList>
                <compareText text="${installer_command_line_arguments}" value="--user"   logic="contains"/>
                <compareText text="${installer_command_line_arguments}" value="--group"  logic="contains"/>
                <compareText text="${installer_command_line_arguments}" value="--passwd" logic="contains"/>
            </ruleList>
        </setInstallerVariable>

    </preInstallationActionList>
    
    <parameterList>
        <!--keep variable in both running time and building time-->          
        <stringParameter name="sql_type" ask="0" value=""/>
        
        <directoryParameter name="installdir">
            <description>Installer.Parameter.installdir.description</description>
            <explanation>Installer.Parameter.installdir.explanation</explanation>
            <value></value>
            <default>${platform_install_prefix}/sequoiasql/mysql</default>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>yes</ask>
            <cliOptionName>prefix</cliOptionName>
            <mustBeWritable>yes</mustBeWritable>
            <mustExist>0</mustExist>
            <width>40</width>
        </directoryParameter>
        <parameterGroup name="user_data">
            <insertAfter>installdir</insertAfter>
            <title>${msg(install.para.user.title)}</title>
            <explanation>${msg(install.para.user.explanation)}</explanation>
            <value></value>
            <default></default>
            <parameterList>
                <stringParameter>
                    <name>username</name>
                    <cliOptionName>user</cliOptionName>
                    <description>${msg(install.para.user.username.description)}</description>
                    <explanation></explanation>
                    <value>sdbadmin</value>
                    <default>sdbadmin</default>
                    <allowEmptyValue>0</allowEmptyValue>
                    <width>40</width>
                </stringParameter>
                <stringParameter>
                    <name>groupname</name>
                    <cliOptionName>group</cliOptionName>
                    <description>${msg(install.para.user.groupname.description)}</description>
                    <explanation></explanation>
                    <value>${username}_group</value>
                    <default>${username}_group</default>
                    <allowEmptyValue>0</allowEmptyValue>
                    <width>40</width>
                </stringParameter>
                <passwordParameter>
                    <name>userpasswd</name>
                    <cliOptionName>passwd</cliOptionName>
                    <description>${msg(install.para.user.password.description)}</description>
                    <explanation></explanation>
                    <value></value>
                    <default>${username}</default>
                    <allowEmptyValue>0</allowEmptyValue>
                    <descriptionRetype>${msg(install.para.user.reentrypw.description)}</descriptionRetype>
                    <width>40</width>                           
                </passwordParameter>
            </parameterList>
        </parameterGroup>
    
    </parameterList>
    
    <readyToInstallActionList>  
        <!--remove last '/' in installdir-->
        <setInstallerVariableFromRegEx>
            <name>installdir</name>
            <pattern>/+$</pattern>
            <substitution></substitution>
            <text>${installdir}</text>
        </setInstallerVariableFromRegEx>
        <!--remove last '\' in installdir-->
        <setInstallerVariableFromRegEx>
            <name>installdir</name>
            <pattern>\\+$</pattern>
            <substitution></substitution>
            <text>${installdir}</text>
        </setInstallerVariableFromRegEx>
        <setInstallerVariable name="project.rollbackBackupDirectory" value="${installdir}/rollback/BackupDir_${time}"/>
        
        <actionGroup>
           <actionList>
              <propertiesFileGet>
                  <file>${sys_conf_file}</file>
                  <key>INSTALL_DIR</key>
                  <variable>installdir_inconf</variable>
                  <abortOnError>0</abortOnError>
                  <showMessageOnError>0</showMessageOnError>
              </propertiesFileGet>
              <setInstallerVariable name="exist_installinfo" value="true">
                  <ruleList>
                      <compareText logic="equals" text="${installdir_inconf}" value="${installdir}"/>
                  </ruleList>
              </setInstallerVariable>
           </actionList>
        </actionGroup>
        <actionGroup>
           <actionList>
              <consoleWrite text="&#xA;${msg(install.show.checkinstalldir.text)}&#xA;">
                  <ruleEvaluationLogic>and</ruleEvaluationLogic>
                  <ruleList>                                                                      
                      <fileTest condition="is_not_empty" path="${installdir}"/>
                      <isTrue value="${exist_installinfo}" />
                  </ruleList>
              </consoleWrite>
              <exit exitCode="0">
                  <ruleList>                                                                      
                      <fileTest condition="is_not_empty" path="${installdir}"/>
                      <isTrue value="${exist_installinfo}" />
                  </ruleList>
              </exit>
           </actionList>
        </actionGroup>
        <!--check disk-->
        <checkFreeDiskSpaceFunction/>

        <!--check umask-->
        <checkUmaskFunction/>
        
        <!--check or create user group-->
        <throwError>
            <text>The ROOT user is not allowed to create.</text>
            <ruleList>
                <compareValues>
                    <logic>equals</logic>
                    <value1>${username}</value1>
                    <value2>root</value2>
                </compareValues>
            </ruleList>
        </throwError>

        <setInstallerVariable name="exist_user" value="false"/>
        <setInstallerVariable>
            <name>exist_user</name>
            <value>true</value>
            <ruleList>
                <userTest logic="exists" username="${username}"/>
            </ruleList>
        </setInstallerVariable>

        <setInstallerVariable name="exist_group" value="false"/>
        <runProgram>
            <program>grep</program>
            <programArguments>"^$groupname:" /etc/group</programArguments>
            <abortOnError>0</abortOnError>
            <showMessageOnError>0</showMessageOnError>
        </runProgram>
        <setInstallerVariable name="exist_group" value="true">
             <ruleList>
                 <compareText logic="equals" text="${program_exit_code}" value="0"/>
             </ruleList>
        </setInstallerVariable>


        <actionGroup>
            <ruleList>
                <isTrue value="${exist_user}"/>
            </ruleList>
            <actionList>
                <setInstallerVariableFromScriptOutput>
                    <name>actual_group</name>
                    <exec>id</exec>
                    <execArgs>-ng ${username}</execArgs>
                </setInstallerVariableFromScriptOutput>
                <throwError>
                    <text>${msg(Install.ErrorMsg.CheckGroup)}</text>
                    <ruleList>
                        <compareValues value1="${actual_group}" logic="does_not_equal" value2="${groupname}"/>
                    </ruleList>
                </throwError>
                <createDirectory path="~${username}"/>
            </actionList>
        </actionGroup>

        <actionGroup>
            <ruleList>
                <isFalse value="${exist_user}"/>
            </ruleList>
            <actionList>
                <addGroup> <!--if group exists, <addGroup> will not throw error-->
                    <customErrorMessage>${msg(Install.ErrorMsg.CreateGroup)}</customErrorMessage>
                    <groupname>${groupname}</groupname>
                </addGroup>
                <setInstallerVariable name="add_group_done" value="true">
                     <ruleEvaluationLogic>and</ruleEvaluationLogic>
                     <ruleList>
                         <isTrue value="${exist_group}"/>
                         <compareText logic="equals" text="${program_exit_code}" value="0"/>
                     </ruleList>
                </setInstallerVariable>
                <runProgram>
                    <customErrorMessage>${msg(Install.ErrorMsg.CreateUser)}</customErrorMessage>
                    <program>useradd</program>
                    <programArguments>${username} -m -p ${userpasswd} -g ${groupname}  -s /bin/bash </programArguments>
                </runProgram>
                <setInstallerVariable name="add_user_done" value="true">
                     <ruleList>
                         <compareText logic="equals" text="${program_exit_code}" value="0"/>
                     </ruleList>
                </setInstallerVariable>
            </actionList>
        </actionGroup>

        <runProgram>
            <program>echo</program>
            <programArguments> ${username}:${userpasswd} | chpasswd</programArguments>
        </runProgram>


    </readyToInstallActionList>

    <componentList>
        <component>
            <name>normal_component</name>
            <folderList>
                <folder>
                    <name>files</name>
                    <destination>${installdir}</destination>
                    <distributionFileList>
                        <distributionDirectory>
                            <allowWildcards>1</allowWildcards>
                            <origin>${build_project_directory}/mysql/*</origin>
                            <excludeFiles></excludeFiles>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
            </folderList>
        </component>
    </componentList>
    
    <postInstallationActionList>
        <!--update installdir/support-files/mysql.server-->
        <substitute>
            <files>${installdir}/support-files/mysql.server</files>
            <type>exact</type>
            <substitutionList>
                <substitution pattern="/opt/sequoiasql/mysql" value="${installdir}"/>
            </substitutionList>
        </substitute>
        
        <!--write /etc/default/sequoiasql-mysql-->
        <deleteFile path="${sys_conf_file}"/>
        <touchFile path="${sys_conf_file}"/>
        <setInstallerVariable name="add_sysconf_done" value="true">
             <ruleList>
                 <compareText logic="equals" text="${program_exit_code}" value="0"/>
             </ruleList>
        </setInstallerVariable>
        <addFilesToUninstaller files="${sys_conf_file}"/>
        <changePermissions files="${sys_conf_file}" permissions="0644"/>
        <propertiesFileSet>
            <file>${sys_conf_file}</file>
            <key>VERSION</key>
            <value>${product_version}</value>
        </propertiesFileSet>
        <propertiesFileSet>
            <file>${sys_conf_file}</file>
            <key>USER</key>
            <value>${username}</value>
        </propertiesFileSet>
        <propertiesFileSet>
            <file>${sys_conf_file}</file>
            <key>INSTALL_DIR</key>
            <value>${installdir}</value>
        </propertiesFileSet>
        <setInstallerVariable name="md5sum" value="0000"/>
        <setInstallerVariableFromScriptOutput>
            <exec>md5sum</exec>
            <execArgs>"${installer_pathname}" | cut -c 1-32 </execArgs>
            <name>md5sum</name>
        </setInstallerVariableFromScriptOutput>
        <propertiesFileSet>
            <file>${sys_conf_file}</file>
            <key>MD5</key>
            <value>${md5sum}</value>
        </propertiesFileSet>

    </postInstallationActionList>

    <installationAbortedActionList>
        <runProgram>
            <customErrorMessage>${msg(install.errmsg.deleteuser)}</customErrorMessage>
            <program>userdel</program>
            <programArguments>${username}</programArguments>
            <ruleList>
                <isTrue value="${add_user_done}"/>
            </ruleList>
        </runProgram>
        <deleteGroup>
            <groupname>${groupname}</groupname>
            <ruleList>
                <isTrue value="${add_group_done}"/>
            </ruleList>
        </deleteGroup>
    </installationAbortedActionList>
    

    <enableDebugger>1</enableDebugger>
    <enableRollback>1</enableRollback>
    <enableTimestamp>1</enableTimestamp>
    <requireInstallationByRootUser>1</requireInstallationByRootUser>
    <saveRelativePaths>1</saveRelativePaths>
    <singleInstanceCheck>1</singleInstanceCheck>
    <defaultUnixGroup>${groupname}</defaultUnixGroup>
    <defaultUnixOwner>${username}</defaultUnixOwner>
    <vendor>SequoiaSQL-MySQL</vendor>

</project>

